<!--pages/result/result.wxml-->
<view class="container">
  <!-- é‚€è¯·ç å¡ç‰‡ -->
  <view class="code-card" wx:if="{{isCreator}}">
    <view class="code-title">é‚€è¯·ç </view>
    <view class="code-value">{{code}}</view>
    <view class="code-actions">
      <button class="btn-action" bindtap="copyCode">å¤åˆ¶é‚€è¯·ç </button>
      <button class="btn-action btn-share" open-type="share">åˆ†äº«ç»™æœ‹å‹</button>
    </view>
  </view>
  
  <!-- å‚ä¸è€…ä¿¡æ¯ -->
  <view class="section" wx:if="{{gathering}}">
    <view class="section-header">
      <text class="section-title">å‚ä¸è€…ï¼ˆ{{gathering.participants.length}}äººï¼‰</text>
      <view class="section-actions">
        <button class="btn-add-participant" bindtap="showAddParticipant">
          <text class="btn-icon">â•</text>
          <text>æ·»åŠ </text>
        </button>
        <button class="btn-refresh" bindtap="refreshRecommendations">
          <text class="refresh-icon">ğŸ”„</text>
          <text>åˆ·æ–°</text>
        </button>
      </view>
    </view>

    <scroll-view
      class="participant-scroll"
      scroll-x
      enable-flex
      show-scrollbar="{{false}}"
      scroll-with-animation>
      <view class="participant-list-h">
        <view class="participant-card" wx:for="{{gathering.participants}}" wx:key="temp_id">
          <view class="participant-avatar">{{item.nickname[0] || 'åŒ¿'}}</view>
          <view class="participant-info">
            <text class="participant-name">{{item.nickname || 'åŒ¿å'}}</text>
            <text class="participant-addr">{{item.location ? item.location.address : 'æœªå®šä½'}}</text>
          </view>
          <view class="participant-delete" bindtap="deleteParticipant" data-id="{{item.temp_id}}">
            <text class="delete-icon">âœ•</text>
          </view>
        </view>
      </view>
    </scroll-view>
  </view>
  
  <!-- å•äººæ¨¡å¼æç¤º -->
  <view class="invite-banner" wx:if="{{isSinglePerson}}">
    <view class="invite-icon">ğŸ‘¥</view>
    <view class="invite-content">
      <view class="invite-title">é‚€è¯·æ›´å¤šå¥½å‹åŠ å…¥</view>
      <view class="invite-text">å½“å‰åªæœ‰æ‚¨ä¸€ä¸ªäººï¼Œé‚€è¯·å¥½å‹åŠ å…¥åå³å¯æ™ºèƒ½æ¨èæœ€ä½³èšä¼šåœ°ç‚¹</view>
    </view>
  </view>

  <!-- æ¨èç»“æœ / é™„è¿‘åœ°ç‚¹ -->
  <view class="section">
    <!-- å•äººæ¨¡å¼ï¼šæ˜¾ç¤ºé™„è¿‘åœ°ç‚¹ -->
    <view wx:if="{{isSinglePerson}}">
      <view class="section-title">
        <text>æ‚¨é™„è¿‘çš„åœ°ç‚¹</text>
        <view class="section-subtitle">é‚€è¯·å¥½å‹åŠ å…¥åå¯è·å¾—æ›´æ™ºèƒ½çš„æ¨è</view>
      </view>

      <!-- åŠ è½½ä¸­ -->
      <view wx:if="{{isLoading}}" class="loading-box">
        <view class="loading">
          <text class="loading-text">æ­£åœ¨æœç´¢é™„è¿‘åœ°ç‚¹...</text>
        </view>
      </view>

      <!-- é™„è¿‘åœ°ç‚¹åˆ—è¡¨ -->
      <view wx:elif="{{nearbyPlaces.length > 0}}" class="nearby-list">
        <view
          class="nearby-item card"
          wx:for="{{nearbyPlaces}}"
          wx:key="id"
          bindtap="viewNearbyDetail"
          data-index="{{index}}"
        >
          <view class="nearby-header">
            <view class="nearby-icon">ğŸ“</view>
            <view class="nearby-content">
              <view class="nearby-name">{{item.name}}</view>
              <view class="nearby-address">{{item.address}}</view>
            </view>
          </view>

          <view class="nearby-info">
            <view class="nearby-tag" wx:if="{{item.distance}}">
              <text>è·ç¦» {{item.distance}}ç±³</text>
            </view>
            <view class="nearby-tag" wx:if="{{item.rating}}">
              <text>â­ {{item.rating}}åˆ†</text>
            </view>
          </view>
        </view>
      </view>

      <!-- æ— é™„è¿‘åœ°ç‚¹ -->
      <view wx:else class="empty-box">
        <text class="empty-text">æš‚æ— é™„è¿‘åœ°ç‚¹</text>
        <text class="empty-hint">è¯·ç¨åé‡è¯•</text>
      </view>
    </view>

    <!-- å¤šäººæ¨¡å¼ï¼šæ˜¾ç¤ºæ™ºèƒ½æ¨è -->
    <view wx:else>
      <view class="section-header">
        <view class="section-title">æ™ºèƒ½æ¨èåœ°ç‚¹</view>
        <button class="btn-add-place" bindtap="showAddPlace">
          <text class="btn-icon">ğŸ“</text>
          <text>æ·»åŠ åœ°ç‚¹</text>
        </button>
      </view>

      <!-- åŠ è½½ä¸­ -->
      <view wx:if="{{isLoading}}" class="loading-box">
        <view class="loading">
          <text class="loading-text">æ­£åœ¨è®¡ç®—æœ€ä½³åœ°ç‚¹...</text>
        </view>
      </view>

      <!-- æ¨èåˆ—è¡¨ -->
      <view wx:elif="{{recommendations.length > 0}}" class="recommend-list">
        <view
          class="recommend-item card"
          wx:for="{{recommendations}}"
          wx:key="id"
        >
          <view class="recommend-header">
            <view class="recommend-rank">{{index + 1}}</view>
            <view class="recommend-content" bindtap="viewDetail" data-index="{{index}}">
              <view class="recommend-name">{{item.name}}</view>
              <view class="recommend-address">{{item.address}}</view>
            </view>
            <view class="recommend-delete" bindtap="deletePlace" data-id="{{item.id}}">
              <text class="delete-icon">âœ•</text>
            </view>
          </view>

          <view class="recommend-stats">
            <view class="stat-item">
              <text class="stat-label">å¹³å‡é€šå‹¤</text>
              <text class="stat-value">{{item.avg_travel_time}}åˆ†é’Ÿ</text>
            </view>
            <view class="stat-item" wx:if="{{item.rating}}">
              <text class="stat-label">è¯„åˆ†</text>
              <text class="stat-value">{{item.rating}}åˆ†</text>
            </view>
            <view class="stat-item">
              <text class="stat-label">åŒ¹é…åº¦</text>
              <text class="stat-value">{{item.score}}%</text>
            </view>
          </view>

          <!-- å„å‚ä¸è€…è·ç¦»ä¿¡æ¯ -->
          <view class="participant-distances" wx:if="{{item.participant_distances && item.participant_distances.length > 0}}">
            <view class="distances-title">å„å‚ä¸è€…è·ç¦»</view>
            <scroll-view class="distances-scroll" scroll-x show-scrollbar="{{false}}" enable-flex scroll-with-animation>
              <view class="distances-list">
                <view class="distance-item" wx:for="{{item.participant_distances}}" wx:key="temp_id" wx:for-item="dist">
                  <view class="distance-avatar">{{dist.nickname[0] || 'åŒ¿'}}</view>
                  <view class="distance-info">
                    <text class="distance-name">{{dist.nickname}}</text>
                    <text class="distance-value">{{dist.distance}}km Â· {{dist.travel_time}}åˆ†é’Ÿ</text>
                  </view>
                </view>
              </view>
            </scroll-view>
          </view>

          <view class="recommend-actions">
            <button class="btn-navigate" catchtap="navigate" data-place="{{item}}">
              <text>å¯¼èˆª</text>
            </button>
          </view>
        </view>
      </view>

      <!-- æ— æ¨è -->
      <view wx:else class="empty-box">
        <text class="empty-text">æš‚æ— æ¨èåœ°ç‚¹</text>
        <text class="empty-hint">ç‚¹å‡»ä¸Šæ–¹"æ·»åŠ åœ°ç‚¹"æ‰‹åŠ¨æ·»åŠ å€™é€‰åœ°ç‚¹</text>
      </view>
    </view>
  </view>
  
  <!-- åº•éƒ¨æ“ä½œ -->
  <view class="bottom-bar">
    <button class="btn-home" bindtap="goHome">è¿”å›é¦–é¡µ</button>
    <button class="btn-share" open-type="share">é‚€è¯·æœ‹å‹</button>
  </view>
</view>

<!-- æ·»åŠ å‚ä¸è€…å¼¹çª— -->
<view class="modal-mask {{showAddParticipantModal ? 'show' : ''}}"
      wx:if="{{showAddParticipantModal}}"
      bindtap="hideAddParticipant"
      catchtouchmove="preventTouchMove">
</view>

<view class="form-modal {{showAddParticipantModal ? 'show' : ''}}"
      wx:if="{{showAddParticipantModal}}"
      catchtouchmove="preventTouchMove">
  <view class="modal-header">
    <text class="modal-title">æ·»åŠ å‚ä¸è€…</text>
    <view class="modal-close" bindtap="hideAddParticipant">
      <text class="modal-close-icon">âœ•</text>
    </view>
  </view>

  <view class="modal-body">
    <view class="form-item">
      <view class="form-label">æ˜µç§°</view>
      <input class="form-input"
             placeholder="è¯·è¾“å…¥æ˜µç§°"
             value="{{newParticipant.nickname}}"
             bindinput="onParticipantNicknameInput"/>
    </view>

    <view class="form-item">
      <view class="form-label">ä½ç½®</view>
      <view class="form-location" bindtap="chooseParticipantLocation">
        <text class="location-text">{{newParticipant.location ? newParticipant.location.address : 'ç‚¹å‡»é€‰æ‹©ä½ç½®'}}</text>
        <text class="location-arrow">â€º</text>
      </view>
    </view>

    <view class="form-item">
      <view class="form-label">äº¤é€šæ–¹å¼</view>
      <view class="transport-options">
        <view class="transport-option {{newParticipant.transport_mode === 'driving' ? 'active' : ''}}"
              bindtap="selectTransport"
              data-mode="driving">
          <text>ğŸš— é©¾è½¦</text>
        </view>
        <view class="transport-option {{newParticipant.transport_mode === 'transit' ? 'active' : ''}}"
              bindtap="selectTransport"
              data-mode="transit">
          <text>ğŸšŒ å…¬äº¤</text>
        </view>
        <view class="transport-option {{newParticipant.transport_mode === 'walking' ? 'active' : ''}}"
              bindtap="selectTransport"
              data-mode="walking">
          <text>ğŸš¶ æ­¥è¡Œ</text>
        </view>
      </view>
    </view>
  </view>

  <view class="modal-footer">
    <button class="btn-cancel" bindtap="hideAddParticipant">å–æ¶ˆ</button>
    <button class="btn-confirm" bindtap="confirmAddParticipant">ç¡®å®šæ·»åŠ </button>
  </view>
</view>

<!-- æ·»åŠ åœ°ç‚¹å¼¹çª— -->
<view class="modal-mask {{showAddPlaceModal ? 'show' : ''}}"
      wx:if="{{showAddPlaceModal}}"
      bindtap="hideAddPlace"
      catchtouchmove="preventTouchMove">
</view>

<view class="form-modal {{showAddPlaceModal ? 'show' : ''}}"
      wx:if="{{showAddPlaceModal}}"
      catchtouchmove="preventTouchMove">
  <view class="modal-header">
    <text class="modal-title">æ·»åŠ å€™é€‰åœ°ç‚¹</text>
    <view class="modal-close" bindtap="hideAddPlace">
      <text class="modal-close-icon">âœ•</text>
    </view>
  </view>

  <view class="modal-body">
    <view class="form-item">
      <view class="form-label">åœ°ç‚¹åç§°</view>
      <input class="form-input"
             placeholder="è¯·è¾“å…¥åœ°ç‚¹åç§°"
             value="{{newPlace.name}}"
             bindinput="onPlaceNameInput"/>
    </view>

    <view class="form-item">
      <view class="form-label">åœ°ç‚¹ä½ç½®</view>
      <view class="form-location" bindtap="choosePlaceLocation">
        <text class="location-text">{{newPlace.address || 'ç‚¹å‡»é€‰æ‹©ä½ç½®'}}</text>
        <text class="location-arrow">â€º</text>
      </view>
    </view>

    <view class="form-item" wx:if="{{newPlace.address}}">
      <view class="form-label">è¯„åˆ†ï¼ˆå¯é€‰ï¼‰</view>
      <input class="form-input"
             type="digit"
             placeholder="1-5åˆ†"
             value="{{newPlace.rating}}"
             bindinput="onPlaceRatingInput"/>
    </view>
  </view>

  <view class="modal-footer">
    <button class="btn-cancel" bindtap="hideAddPlace">å–æ¶ˆ</button>
    <button class="btn-confirm" bindtap="confirmAddPlace">ç¡®å®šæ·»åŠ </button>
  </view>
</view>